<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Surat Jalan MKI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
    .input-field { @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2; }
    .label-text { @apply block text-sm font-medium text-gray-700; }
    .modal { transition: opacity 0.25s ease; }
    body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    
    /* Style Tabel */
    .table-bordered { border-collapse: collapse; width: 100%; }
    .table-bordered th, .table-bordered td { border: 1px solid #cbd5e1; }

    /* Tab Active State */
    .tab-btn.active { @apply border-indigo-500 text-indigo-600 bg-indigo-50; }
    
    /* Setting Input: Type Text agar fleksibel, bg-white agar terlihat aktif */
    .setting-input { @apply w-full text-center border-gray-300 h-8 text-xs border rounded bg-white text-gray-900 font-semibold focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500; }
  </style>
</head>
<body class="py-6 px-4 sm:px-8">

  <!-- DATALIST GLOBAL -->
  <datalist id="listCustomers"></datalist>
  <datalist id="listItems"></datalist>

  <div class="max-w-6xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden relative min-h-[800px]">
    
    <!-- NAVIGATION TABS -->
    <div class="bg-white border-b border-gray-200">
      <nav class="-mb-px flex" aria-label="Tabs">
        <button onclick="switchTab('tab-transaksi')" id="btn-tab-transaksi" class="tab-btn active w-1/3 py-4 px-1 text-center border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
          <i class="fa-solid fa-file-invoice mr-2"></i> Input Transaksi
        </button>
        <button onclick="switchTab('tab-customer')" id="btn-tab-customer" class="tab-btn w-1/3 py-4 px-1 text-center border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
          <i class="fa-solid fa-users mr-2"></i> Master Customer
        </button>
        <button onclick="switchTab('tab-item')" id="btn-tab-item" class="tab-btn w-1/3 py-4 px-1 text-center border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
          <i class="fa-solid fa-box-open mr-2"></i> Master Item
        </button>
      </nav>
    </div>

    <!-- ================= TAB 1: INPUT SURAT JALAN ================= -->
    <div id="tab-transaksi" class="tab-content">
      <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center">
        <div>
          <h2 class="text-xl font-bold text-white">Input Surat Jalan</h2>
          <div id="loadingDataStatus" class="text-indigo-100 text-xs mt-1">Memuat Data...</div>
        </div>
        <div class="flex items-center gap-4">
           <button type="button" onclick="handlePreview()" class="text-indigo-200 hover:text-white flex flex-col items-center">
              <i class="fa-solid fa-eye"></i><span class="text-[10px]">Preview</span>
           </button>
           <button type="button" onclick="toggleSettingsModal()" class="text-indigo-200 hover:text-white flex flex-col items-center">
              <i class="fa-solid fa-sliders"></i><span class="text-[10px]">Setting</span>
           </button>
        </div>
      </div>

      <form id="spjForm" class="p-6 space-y-6" onsubmit="handleFormSubmit(event)">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Kolom Kiri -->
          <div class="space-y-4">
            <div>
              <label class="label-text">Pilih Customer</label>
              <input list="listCustomers" id="inputCustomerName" class="input-field bg-indigo-50 font-bold" placeholder="Ketik nama customer..." onchange="autoFillCustomer(this)">
            </div>
            <div>
              <label class="label-text">Alamat Lengkap</label>
              <textarea name="tujuan" id="inputCustomerAddress" required class="input-field h-24"></textarea>
            </div>
             <div class="grid grid-cols-2 gap-2 mt-4">
               <div>
                  <label class="label-text">Jumlah Pallet</label>
                  <input type="text" name="pallet" class="input-field">
               </div>
             </div>
          </div>

          <!-- Kolom Kanan -->
          <div class="space-y-3 bg-gray-50 p-4 rounded-md border">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="label-text">No. Surat Jalan</label>
                <input type="text" name="no_sj" required class="input-field" placeholder="SDO-MKI/...">
              </div>
              <div>
                <label class="label-text">Tanggal</label>
                <input type="date" name="tanggal" required class="input-field">
              </div>
            </div>
            <div>
              <label class="label-text">No. Sales Order (SO)</label>
              <input type="text" name="no_so" class="input-field">
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="label-text">Transporter</label>
                <input type="text" name="transporter" class="input-field">
              </div>
              <div>
                <label class="label-text">Nama Driver</label>
                <input type="text" name="driver" class="input-field">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="label-text">Tipe Truk</label>
                <input type="text" name="tipe_truk" class="input-field">
              </div>
              <div>
                <label class="label-text">No. Polisi Truk</label>
                <input type="text" name="no_truk" class="input-field">
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="flex justify-between items-center border-b pb-2 mb-3">
             <h3 class="text-lg font-medium text-gray-900">Daftar Barang</h3>
             <span class="text-xs text-gray-500">*Ketik Nama Item untuk Auto-fill</span>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full table-bordered" id="itemTable">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-3 py-2 w-1/4">Nama Item</th>
                  <th class="px-3 py-2 w-20">Kode</th>
                  <th class="px-3 py-2 w-16">UoM</th>
                  <th class="px-3 py-2 w-20">Qty Pesan</th>
                  <th class="px-3 py-2 w-20">Qty Kirim</th>
                  <th class="px-3 py-2 w-20">Berat</th>
                  <th class="px-3 py-2 w-24">Total(Ton)</th>
                  <th class="px-2 py-2 w-10"></th>
                </tr>
              </thead>
              <tbody class="bg-white" id="tableBody"></tbody>
            </table>
          </div>
          <button type="button" onclick="addRow()" class="mt-3 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200">
            + Tambah Baris
          </button>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button type="submit" id="btnSave" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <i class="fa-solid fa-paper-plane mr-2 mt-0.5"></i> Simpan Transaksi & PDF
          </button>
        </div>
        <div id="statusMessage" class="hidden p-4 rounded-md"></div>
      </form>
    </div>

    <!-- ================= TAB 2 & 3: MASTER DATA ================= -->
    <div id="tab-customer" class="tab-content hidden p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4">Master Customer</h3>
       <div class="bg-gray-50 p-4 rounded border mb-6">
         <form onsubmit="handleMasterSubmit(event, 'save_customer')">
           <div class="grid grid-cols-1 gap-4">
             <div><label class="label-text">Nama Customer</label><input type="text" name="nama" required class="input-field"></div>
             <div><label class="label-text">Alamat</label><textarea name="alamat" required class="input-field h-20"></textarea></div>
             <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Simpan</button>
           </div>
         </form>
       </div>
       <div class="overflow-auto max-h-96 border rounded"><table class="min-w-full table-bordered"><tbody id="displayCustomers"></tbody></table></div>
    </div>

    <div id="tab-item" class="tab-content hidden p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4">Master Item</h3>
       <div class="bg-gray-50 p-4 rounded border mb-6">
         <form onsubmit="handleMasterSubmit(event, 'save_item')">
           <div class="grid grid-cols-2 gap-4">
             <div><label class="label-text">Kode</label><input type="text" name="kode" required class="input-field"></div>
             <div><label class="label-text">Nama</label><input type="text" name="nama" required class="input-field"></div>
             <div class="col-span-2"><label class="label-text">UoM</label><input type="text" name="uom" required class="input-field"></div>
             <div class="col-span-2"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Simpan</button></div>
           </div>
         </form>
       </div>
       <div class="overflow-auto max-h-96 border rounded"><table class="min-w-full table-bordered"><tbody id="displayItems"></tbody></table></div>
    </div>

  </div>

  <!-- MODAL PENGATURAN LENGKAP -->
  <div id="settingsModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="toggleSettingsModal()"></div>
      
      <!-- Content Modal -->
      <div class="inline-block px-4 pt-5 pb-4 bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full sm:p-6 text-left relative z-50" onclick="event.stopPropagation()">
         
         <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-lg font-bold text-gray-900">Pengaturan Posisi Cetak (mm)</h3>
            <button type="button" onclick="toggleSettingsModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
         </div>

         <div class="h-[70vh] overflow-y-auto pr-2">
             <div class="mb-4 bg-blue-50 p-3 rounded text-xs text-blue-800">
                <i class="fa-solid fa-info-circle mr-1"></i> <strong>Tips:</strong> Gunakan titik (.) untuk desimal. Contoh: 165.5
             </div>

             <!-- UMUM -->
             <div class="mb-4 bg-white p-3 rounded border border-gray-200 shadow-sm">
                <h4 class="font-bold text-indigo-700 text-sm mb-2 border-b border-gray-100 pb-1">1. Umum</h4>
                <div class="grid grid-cols-3 gap-4">
                   <div><label class="text-xs font-semibold block mb-1">Ukuran Font (pt)</label><input type="text" id="conf_fontSize" class="setting-input"></div>
                </div>
             </div>

             <!-- POSISI HEADER -->
             <div class="mb-4 bg-white p-3 rounded border border-gray-200 shadow-sm">
                <h4 class="font-bold text-indigo-700 text-sm mb-2 border-b border-gray-100 pb-1">2. Posisi Header (Atur Koordinat)</h4>
                <div class="grid grid-cols-12 gap-2 text-xs font-semibold text-gray-600 mb-2 bg-gray-50 p-1 rounded">
                    <div class="col-span-4">Nama Kolom</div>
                    <div class="col-span-4 text-center">Posisi X (Kiri-Kanan)</div>
                    <div class="col-span-4 text-center">Posisi Y (Atas-Bawah)</div>
                </div>
                <div id="headerConfigContainer" class="space-y-2"></div>
             </div>

             <!-- POSISI TABEL -->
             <div class="mb-4 bg-white p-3 rounded border border-gray-200 shadow-sm">
                <h4 class="font-bold text-indigo-700 text-sm mb-2 border-b border-gray-100 pb-1">3. Posisi Daftar Barang (Tabel)</h4>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div><label class="text-xs font-semibold block mb-1">Posisi Mulai Tabel (Y)</label><input type="text" id="conf_tableY" class="setting-input"></div>
                    <div><label class="text-xs font-semibold block mb-1">Tinggi Baris (Row Height)</label><input type="text" id="conf_rowH" class="setting-input"></div>
                </div>
                <div class="grid grid-cols-12 gap-2 text-xs font-semibold text-gray-600 mb-2 bg-gray-50 p-1 rounded">
                    <div class="col-span-4">Kolom Tabel</div>
                    <div class="col-span-8 text-center">Posisi X (Kiri-Kanan)</div>
                </div>
                <div id="tableConfigContainer" class="space-y-2"></div>
             </div>
         </div>

         <div class="mt-4 flex gap-2 border-t pt-4 bg-white sticky bottom-0 justify-between">
            <button onclick="resetDefaultSettings()" class="py-2 px-4 text-xs text-red-600 hover:text-red-800 font-medium">
               <i class="fa-solid fa-undo mr-1"></i> Reset Default
            </button>
            <button id="btnSaveSetting" onclick="saveSettings()" class="py-2 px-6 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-bold shadow">
                <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Simpan Setting Permanen
            </button>
         </div>
      </div>
    </div>
  </div>

  <!-- MODAL PREVIEW -->
  <div id="previewModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-90" onclick="closePreview()"></div>
      <div class="inline-block bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:align-middle sm:max-w-5xl sm:w-full h-[90vh] flex flex-col">
        <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
          <h3 class="text-lg font-medium text-gray-900">Preview PDF</h3>
          <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <div class="flex-grow bg-gray-500 p-4">
            <iframe id="pdfPreviewFrame" class="w-full h-full rounded shadow-lg border-0"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const APP_CONFIG = {
        script_url: 'https://script.google.com/macros/s/AKfycbw6hzLyjrLxLVDS2j6m8Q7abXP2t3gOcZyW5QBH3FFLnNXOm-6_fYW3TggeA-1fsFhqDA/exec', 
        wa_token: 'T9SCfr4hZSmGEy8ngizJ',
        wa_target: '6282258110899-1604625450@g.us,120363395452543087@g.us'
    };

    let MASTER_CUSTOMERS = [];
    let MASTER_ITEMS = [];
    
    // DEFAULT LAYOUT (Jika Sheet4 Kosong)
    const DEFAULT_LAYOUT = {
      fontSize: 10,
      fontName: 'courier',
      fields: {
          customer:    { label: "Customer (Tujuan)", x: 25, y: 35, w: 80 }, 
          no_sj:       { label: "No. Surat Jalan", x: 165, y: 22 },
          tanggal:     { label: "Tanggal", x: 165, y: 26 },
          no_so:       { label: "No. Sales Order (SO)", x: 165, y: 30 },
          transporter: { label: "Transporter", x: 165, y: 34 },
          driver:      { label: "Nama Driver", x: 165, y: 38 },
          tipe_truk:   { label: "Tipe Truk", x: 165, y: 42 },
          no_truk:     { label: "No. Polisi Truk", x: 165, y: 46 },
          pallet:      { label: "Footer Pallet", x: 95, y: 143 }
      },
      table: { 
          startY: 68, 
          rowHeight: 6, 
          cols: { 
              kode: { label: "Kode Item", x: 17 }, 
              nama: { label: "Nama Item", x: 47 }, 
              uom:  { label: "UoM", x: 100 }, 
              qty_pesan: { label: "Qty Pesan", x: 115 }, 
              qty_kirim: { label: "Qty Kirim", x: 135 }, 
              berat: { label: "Berat (kg)", x: 155 }, 
              total: { label: "Total (Ton)", x: 180 } 
          } 
      }
    };
    
    let LAYOUT_CONFIG = JSON.parse(JSON.stringify(DEFAULT_LAYOUT)); // Clone

    window.onload = function() {
      fetchMasterData(); 
      fetchSettingsData();
      addRow(); 
      document.querySelector('input[name="tanggal"]').valueAsDate = new Date();
      renderSettingsModal();
    };

    function switchTab(tabId) {
       document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
       document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active', 'border-indigo-500', 'text-indigo-600', 'bg-indigo-50'));
       document.getElementById(tabId).classList.remove('hidden');
       document.getElementById('btn-'+tabId).classList.add('active', 'border-indigo-500', 'text-indigo-600', 'bg-indigo-50');
    }

    // --- FETCH ---
    async function fetchMasterData() {
       const statusEl = document.getElementById('loadingDataStatus');
       try {
          const response = await fetch(APP_CONFIG.script_url + '?action=get_masters', { method: 'GET', mode: 'cors', credentials: 'omit', redirect: 'follow' });
          const text = await response.text();
          let result;
          try { result = JSON.parse(text); } catch(e) { console.warn("Master Parse Error", text); return; }

          if(result.status === 'success') {
             MASTER_CUSTOMERS = result.customers; MASTER_ITEMS = result.items;
             populateDatalists(); renderMasterTables();
             statusEl.innerHTML = "<span class='text-green-200'><i class='fa-solid fa-check'></i> Master Ready</span>";
          }
       } catch (err) { console.error("Fetch Master Error:", err); }
    }

    async function fetchSettingsData() {
       try {
          const response = await fetch(APP_CONFIG.script_url + '?action=get_settings', { method: 'GET', mode: 'cors', credentials: 'omit', redirect: 'follow' });
          const text = await response.text();
          let result;
          try { result = JSON.parse(text); } catch(e) { console.warn("Setting Parse Error (Using Defaults)", text); return; }

          if(result.status === 'success' && result.data) {
             const serverConf = result.data;
             if(serverConf.fontSize) LAYOUT_CONFIG.fontSize = serverConf.fontSize;
             if(serverConf.fields) LAYOUT_CONFIG.fields = serverConf.fields;
             if(serverConf.table) LAYOUT_CONFIG.table = serverConf.table;
             
             console.log("Setting Loaded:", LAYOUT_CONFIG);
             renderSettingsModal(); 
          }
       } catch (err) { console.error("Fetch Settings Error:", err); }
    }

    // --- RENDER SETTINGS MODAL ---
    function renderSettingsModal() {
        document.getElementById('conf_fontSize').value = LAYOUT_CONFIG.fontSize;
        
        // Header Fields
        const hCont = document.getElementById('headerConfigContainer');
        hCont.innerHTML = '';
        const fieldOrder = ['customer', 'no_sj', 'tanggal', 'no_so', 'transporter', 'driver', 'tipe_truk', 'no_truk', 'pallet'];
        
        fieldOrder.forEach(key => {
            const val = LAYOUT_CONFIG.fields[key];
            if(!val) return;
            hCont.innerHTML += `
                <div class="grid grid-cols-12 gap-2 items-center border-b border-gray-100 py-1">
                    <div class="col-span-4 text-xs font-medium text-gray-700">${val.label}</div>
                    <div class="col-span-4"><input type="text" id="f_x_${key}" value="${val.x}" class="setting-input"></div>
                    <div class="col-span-4"><input type="text" id="f_y_${key}" value="${val.y}" class="setting-input"></div>
                </div>
            `;
        });

        // Table Config
        document.getElementById('conf_tableY').value = LAYOUT_CONFIG.table.startY;
        document.getElementById('conf_rowH').value = LAYOUT_CONFIG.table.rowHeight;
        
        const tCont = document.getElementById('tableConfigContainer');
        tCont.innerHTML = '';
        const colOrder = ['kode', 'nama', 'uom', 'qty_pesan', 'qty_kirim', 'berat', 'total'];
        
        colOrder.forEach(key => {
            const val = LAYOUT_CONFIG.table.cols[key];
            if(!val) return;
            tCont.innerHTML += `
                <div class="grid grid-cols-12 gap-2 items-center border-b border-gray-100 py-1">
                    <div class="col-span-4 text-xs font-medium text-gray-700">${val.label}</div>
                    <div class="col-span-8"><input type="text" id="t_x_${key}" value="${val.x}" class="setting-input"></div>
                </div>
            `;
        });
    }

    // --- SAVE SETTINGS ---
    // Helper untuk parse float yang aman (koma jadi titik)
    function safeFloat(val) {
        if(!val) return 0;
        return parseFloat(String(val).replace(',', '.')) || 0;
    }

    async function saveSettings() {
       const btn = document.getElementById('btnSaveSetting');
       btn.disabled = true; btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> Menyimpan...";
       
       const newConf = JSON.parse(JSON.stringify(LAYOUT_CONFIG));
       newConf.fontSize = safeFloat(document.getElementById('conf_fontSize').value) || 10;
       
       for (const key of Object.keys(newConf.fields)) {
           const elX = document.getElementById(`f_x_${key}`);
           const elY = document.getElementById(`f_y_${key}`);
           if(elX && elY) {
               newConf.fields[key].x = safeFloat(elX.value);
               newConf.fields[key].y = safeFloat(elY.value);
           }
       }
       
       newConf.table.startY = safeFloat(document.getElementById('conf_tableY').value);
       newConf.table.rowHeight = safeFloat(document.getElementById('conf_rowH').value);
       for (const key of Object.keys(newConf.table.cols)) {
           const elX = document.getElementById(`t_x_${key}`);
           if(elX) newConf.table.cols[key].x = safeFloat(elX.value);
       }

       try {
          await postDataToSheet('save_settings', newConf);
          LAYOUT_CONFIG = newConf; 
          alert("Setting Tersimpan!");
          toggleSettingsModal();
       } catch (e) {
          alert("Gagal simpan: " + e.message);
       } finally {
          btn.disabled = false; btn.innerHTML = "<i class='fa-solid fa-cloud-arrow-up mr-2'></i> Simpan Setting Permanen";
       }
    }

    function resetDefaultSettings() {
        if(confirm("Yakin ingin mereset setting ke default?")) {
            LAYOUT_CONFIG = JSON.parse(JSON.stringify(DEFAULT_LAYOUT));
            renderSettingsModal();
        }
    }

    function toggleSettingsModal() { document.getElementById('settingsModal').classList.toggle('hidden'); }

    // --- FORM HANDLING ---
    async function handleFormSubmit(e) {
      e.preventDefault();
      const btn = document.getElementById('btnSave');
      const status = document.getElementById('statusMessage');
      const data = getFormDataFromDOM();
      
      if(!data.header.no_sj) { alert("Isi No Surat Jalan!"); return; }

      btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memproses...';
      status.className = 'hidden';

      try {
         await postDataToSheet('save_sj', data);
         const doc = createPDFObject(data);
         doc.save(`SJ_${data.header.no_sj.replace(/\//g, '-')}.pdf`);
         await sendWhatsappMessage(data);
         status.innerHTML = "✅ Transaksi Disimpan, PDF Download, WA Terkirim!";
         status.className = "mt-4 p-4 bg-green-100 text-green-700 rounded block border border-green-300";
         setTimeout(() => { location.reload(); }, 3000);
      } catch (err) {
         status.innerHTML = "⚠️ Error: " + err.message;
         status.className = "mt-4 p-4 bg-red-100 text-red-700 rounded block border border-red-300";
         btn.disabled = false; btn.innerHTML = 'Coba Lagi';
      }
    }

    // --- PDF GENERATOR (COORDINATE BASED) ---
    function createPDFObject(data) {
      const { jsPDF } = window.jspdf;
      const cfg = LAYOUT_CONFIG;
      const f = cfg.fields;
      
      const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [229, 162] });
      doc.setFont(cfg.fontName, 'normal'); 
      doc.setFontSize(cfg.fontSize);
      
      const txt = (str, x, y) => { if(str) doc.text(String(str).toUpperCase(), x, y); };
      
      txt(data.header.no_sj, f.no_sj.x, f.no_sj.y);
      txt(data.header.tanggal, f.tanggal.x, f.tanggal.y);
      txt(data.header.no_so, f.no_so.x, f.no_so.y);
      txt(data.header.transporter, f.transporter.x, f.transporter.y);
      txt(data.header.driver, f.driver.x, f.driver.y);
      txt(data.header.tipe_truk, f.tipe_truk.x, f.tipe_truk.y);
      txt(data.header.no_truk, f.no_truk.x, f.no_truk.y);
      
      if (data.header.tujuan) { 
         doc.text(doc.splitTextToSize(data.header.tujuan.toUpperCase(), f.customer.w || 80), f.customer.x, f.customer.y); 
      }
      
      let cy = cfg.table.startY;
      const tc = cfg.table.cols;
      
      data.items.forEach(item => {
        txt(item.kode, tc.kode.x, cy);
        txt(item.nama, tc.nama.x, cy);
        txt(item.uom, tc.uom.x, cy);
        txt(item.qty_pesan, tc.qty_pesan.x, cy);
        txt(item.qty_kirim, tc.qty_kirim.x, cy);
        txt(item.berat, tc.berat.x, cy);
        txt(item.total_berat, tc.total.x, cy);
        cy += cfg.table.rowHeight;
      });
      
      txt(data.header.pallet, f.pallet.x, f.pallet.y);
      return doc;
    }

    // --- HELPERS ---
    async function handleMasterSubmit(e, actionType) {
       e.preventDefault();
       const form = e.target;
       const formData = new FormData(form);
       const data = Object.fromEntries(formData.entries());
       
       const btn = form.querySelector('button[type="submit"]');
       const originalText = btn.textContent;
       btn.disabled = true; btn.textContent = "Menyimpan...";

       try {
          await postDataToSheet(actionType, data);
          alert("Data Master Berhasil Disimpan!");
          form.reset();
          fetchMasterData(); 
       } catch (err) { alert("Gagal simpan: " + err.message); } 
       finally { btn.disabled = false; btn.textContent = originalText; }
    }
    
    async function postDataToSheet(action, dataPayload) {
       await fetch(APP_CONFIG.script_url, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: action, data: dataPayload }) });
       return true; 
    }

    function populateDatalists() {
       document.getElementById('listCustomers').innerHTML = MASTER_CUSTOMERS.map(c => `<option value="${c.nama}">`).join('');
       document.getElementById('listItems').innerHTML = MASTER_ITEMS.map(i => `<option value="${i.nama}">Kode: ${i.kode}</option>`).join('');
    }
    function renderMasterTables() { /* Simple renderer to save space */ 
       const c = document.getElementById('displayCustomers'); c.innerHTML = MASTER_CUSTOMERS.map(x=>`<tr><td class='p-1 border'>${x.nama}</td><td class='p-1 border'>${x.alamat}</td></tr>`).join('');
       const i = document.getElementById('displayItems'); i.innerHTML = MASTER_ITEMS.map(x=>`<tr><td class='p-1 border'>${x.kode}</td><td class='p-1 border'>${x.nama}</td><td class='p-1 border'>${x.uom}</td></tr>`).join('');
    }
    
    function addRow() {
      const tbody = document.getElementById('tableBody');
      const tr = document.createElement('tr');
      // UPDATE: item_total[] menggunakan step="any" dan bg-white
      tr.innerHTML = `<td class="px-2 py-1 border border-gray-300"><input list="listItems" name="item_nama[]" class="input-field text-xs h-8 font-bold" placeholder="Cari..." onchange="autoFillItem(this)"></td><td class="px-2 py-1 border border-gray-300"><input type="text" name="item_kode[]" class="input-field text-xs h-8 bg-gray-50" readonly></td><td class="px-2 py-1 border border-gray-300"><input type="text" name="item_uom[]" class="input-field text-xs h-8" oninput="calcRow(this)"></td><td class="px-2 py-1 border border-gray-300"><input type="number" name="item_qty_pesan[]" class="input-field text-xs h-8"></td><td class="px-2 py-1 border border-gray-300"><input type="number" name="item_qty_kirim[]" class="input-field text-xs h-8" oninput="calcRow(this)"></td><td class="px-2 py-1 border border-gray-300"><input type="number" name="item_berat[]" class="input-field text-xs h-8" step="0.01" oninput="calcRow(this)"></td><td class="px-2 py-1 border border-gray-300"><input type="number" name="item_total[]" class="input-field text-xs h-8 bg-white" step="any"></td><td class="px-2 py-1 border border-gray-300 text-center"><button type="button" onclick="this.closest('tr').remove()" class="text-red-600 hover:text-red-900 font-bold px-2">X</button></td>`;
      tbody.appendChild(tr);
    }
    function calcRow(input) {
       if(!input) return;
       const tr = input.closest('tr');
       const uom = tr.querySelector('input[name="item_uom[]"]').value.toUpperCase().trim();
       const qty = parseFloat(tr.querySelector('input[name="item_qty_kirim[]"]').value) || 0;
       const berat = parseFloat(tr.querySelector('input[name="item_berat[]"]').value) || 0;
       let total = 0;
       if (uom === 'KG') total = qty / 1000;
       else if (uom === 'TON') total = qty;
       else total = (qty * berat) / 1000;
       tr.querySelector('input[name="item_total[]"]').value = total.toFixed(3); 
    }
    function autoFillItem(inputEl) {
       const val = inputEl.value;
       const found = MASTER_ITEMS.find(i => i.nama === val);
       if(found) {
          const tr = inputEl.closest('tr');
          tr.querySelector('input[name="item_kode[]"]').value = found.kode;
          tr.querySelector('input[name="item_uom[]"]').value = found.uom;
          calcRow(tr.querySelector('input[name="item_qty_kirim[]"]')); 
       }
    }
    function autoFillCustomer(inputEl) {
       const val = inputEl.value;
       const found = MASTER_CUSTOMERS.find(c => c.nama === val);
       if(found) document.getElementById('inputCustomerAddress').value = found.alamat;
    }
    function getFormDataFromDOM() {
      const form = document.getElementById('spjForm');
      const formData = new FormData(form);
      const data = {
        header: {
          tujuan: document.getElementById('inputCustomerName').value + '\n' + document.getElementById('inputCustomerAddress').value,
          no_sj: formData.get('no_sj'), tanggal: formData.get('tanggal'), no_so: formData.get('no_so'),
          transporter: formData.get('transporter'), tipe_truk: formData.get('tipe_truk'), no_truk: formData.get('no_truk'),
          driver: formData.get('driver'), pallet: formData.get('pallet')
        }, items: []
      };
      const codes = formData.getAll('item_kode[]');
      const names = formData.getAll('item_nama[]');
      const uoms = formData.getAll('item_uom[]');
      const qtyPs = formData.getAll('item_qty_pesan[]');
      const qtyKs = formData.getAll('item_qty_kirim[]');
      const berats = formData.getAll('item_berat[]');
      const totals = formData.getAll('item_total[]');
      for (let i = 0; i < names.length; i++) {
        if (names[i]) data.items.push({ kode: codes[i], nama: names[i], uom: uoms[i], qty_pesan: qtyPs[i], qty_kirim: qtyKs[i], berat: berats[i], total_berat: totals[i] });
      }
      return data;
    }
    function handlePreview() {
      const data = getFormDataFromDOM();
      if(!data.header.no_sj) { alert('Isi No. Surat Jalan!'); return; }
      const doc = createPDFObject(data);
      document.getElementById('pdfPreviewFrame').src = doc.output('datauristring');
      document.getElementById('previewModal').classList.remove('hidden');
    }
    function closePreview() { document.getElementById('previewModal').classList.add('hidden'); }
    async function sendWhatsappMessage(data) {
        let pesan = `*SURAT JALAN BARU*\nNo: ${data.header.no_sj}\nTujuan: ${data.header.tujuan.split('\n')[0]}\n\nItem:\n`;
        data.items.forEach((i, idx) => pesan += `${idx+1}. ${i.nama} (${i.qty_kirim} ${i.uom})\n`);
        const formData = new FormData();
        formData.append('target', APP_CONFIG.wa_target);
        formData.append('message', pesan);
        await fetch('https://api.fonnte.com/send', { method: 'POST', headers: { 'Authorization': APP_CONFIG.wa_token }, body: formData });
    }
  </script>
</body>
</html>
