<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Input Surat Jalan MKI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Library Icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Library PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
    .input-field { @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2; }
    .label-text { @apply block text-sm font-medium text-gray-700; }
    
    /* Modal Transition */
    .modal { transition: opacity 0.25s ease; }
    body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }

    /* Custom Table Border style agar lebih tegas */
    .table-bordered { border-collapse: collapse; width: 100%; }
    .table-bordered th, .table-bordered td { border: 1px solid #cbd5e1; /* gray-300 */ }
  </style>
</head>
<body class="py-10 px-4 sm:px-8">

  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden relative">
    
    <!-- Header dengan Menu Tools -->
    <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center">
      <div>
        <h2 class="text-xl font-bold text-white">Input Surat Jalan MKI</h2>
        <p class="text-indigo-100 text-sm">Setting Printer: Envelope C5 (229x162mm)</p>
      </div>
      
      <!-- MENU: Preview & Settings -->
      <div class="flex items-center gap-5">
        <!-- Menu Preview -->
        <button type="button" onclick="handlePreview()" class="text-indigo-200 hover:text-white transition flex flex-col items-center group" title="Preview PDF">
           <i class="fa-solid fa-eye text-xl mb-1 group-hover:scale-110 transition-transform"></i>
           <span class="text-[10px] font-medium uppercase tracking-wider">Preview</span>
        </button>

        <div class="h-8 w-px bg-indigo-500"></div> <!-- Divider -->

        <!-- Menu Pengaturan -->
        <button type="button" onclick="toggleSettingsModal()" class="text-indigo-200 hover:text-white transition flex flex-col items-center group" title="Pengaturan Kertas">
          <i class="fa-solid fa-gear text-xl mb-1 group-hover:rotate-45 transition-transform duration-300"></i>
          <span class="text-[10px] font-medium uppercase tracking-wider">Setting</span>
        </button>
      </div>
    </div>

    <!-- Form -->
    <form id="spjForm" class="p-6 space-y-6" onsubmit="handleFormSubmit(event)">
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div>
            <label class="label-text">Tujuan (Nama & Alamat Customer)</label>
            <textarea name="tujuan" required class="input-field h-32" placeholder="PT. CONTOH CUSTOMER&#10;Jl. Raya Industri No. 1..."></textarea>
          </div>
        </div>

        <div class="space-y-3 bg-gray-50 p-4 rounded-md border">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="label-text">No. Surat Jalan</label>
              <input type="text" name="no_sj" required class="input-field" placeholder="SDO-MKI/...">
            </div>
            <div>
              <label class="label-text">Tanggal</label>
              <input type="date" name="tanggal" required class="input-field">
            </div>
          </div>
          
          <div>
            <label class="label-text">No. Sales Order (SO)</label>
            <input type="text" name="no_so" class="input-field">
          </div>
          
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="label-text">Transporter</label>
              <input type="text" name="transporter" class="input-field">
            </div>
            <div>
              <label class="label-text">Nama Driver</label>
              <input type="text" name="driver" class="input-field">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="label-text">Tipe Truk</label>
              <input type="text" name="tipe_truk" class="input-field">
            </div>
            <div>
              <label class="label-text">No. Polisi Truk</label>
              <input type="text" name="no_truk" class="input-field">
            </div>
          </div>
        </div>
      </div>

      <div>
        <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mb-3">Daftar Barang</h3>
        <div class="overflow-x-auto">
          <!-- Modifikasi Class Table di sini -->
          <table class="min-w-full table-bordered" id="itemTable">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Kode</th>
                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase w-1/3">Nama Item</th>
                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">UoM</th>
                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Qty Pesan</th>
                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Qty Kirim</th>
                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Berat (kg)</th>
                <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Total (Ton)</th>
                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700">Aksi</th>
              </tr>
            </thead>
            <tbody class="bg-white" id="tableBody">
              </tbody>
          </table>
        </div>
        <button type="button" onclick="addRow()" class="mt-3 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200">
          + Tambah Baris
        </button>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
           <label class="label-text">Jumlah Pallet</label>
           <input type="text" name="pallet" class="input-field w-32">
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t items-center">
        <!-- Tombol Preview Bawah -->
        <button type="button" onclick="handlePreview()" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          <i class="fa-solid fa-eye mr-2 mt-0.5"></i> Cek Preview
        </button>
        
        <!-- Tombol Simpan -->
        <button type="submit" id="btnSave" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
          <i class="fa-solid fa-cloud-arrow-up mr-2 mt-0.5"></i> Simpan, Kirim WA & PDF
        </button>
      </div>
      
      <div id="statusMessage" class="hidden p-4 rounded-md"></div>
    </form>
  </div>

  <!-- MODAL PENGATURAN KERTAS -->
  <div id="settingsModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="toggleSettingsModal()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
      
      <div class="inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-sm sm:w-full sm:p-6">
        <div>
          <div class="flex justify-between items-center border-b pb-2 mb-4">
             <h3 class="text-lg font-medium leading-6 text-gray-900">Pengaturan Kertas</h3>
             <button onclick="toggleSettingsModal()" class="text-gray-400 hover:text-gray-500"><i class="fa-solid fa-times"></i></button>
          </div>
          
          <div class="space-y-4 bg-gray-50 p-3 rounded-md border border-gray-200">
             <div>
               <label class="block text-sm font-bold text-gray-700">Geser Horizontal (X) - mm</label>
               <div class="flex items-center mt-1">
                 <button type="button" onclick="adjustVal('set_offsetX', -1)" class="p-2 bg-gray-200 rounded-l hover:bg-gray-300">-</button>
                 <input type="number" id="set_offsetX" class="block w-full text-center border-gray-300 h-9 border-t border-b" value="5">
                 <button type="button" onclick="adjustVal('set_offsetX', 1)" class="p-2 bg-gray-200 rounded-r hover:bg-gray-300">+</button>
               </div>
               <p class="text-xs text-gray-500 mt-1">Positif (+) ke Kanan, Negatif (-) ke Kiri</p>
             </div>
             
             <div>
               <label class="block text-sm font-bold text-gray-700">Geser Vertikal (Y) - mm</label>
               <div class="flex items-center mt-1">
                 <button type="button" onclick="adjustVal('set_offsetY', -1)" class="p-2 bg-gray-200 rounded-l hover:bg-gray-300">-</button>
                 <input type="number" id="set_offsetY" class="block w-full text-center border-gray-300 h-9 border-t border-b" value="13">
                 <button type="button" onclick="adjustVal('set_offsetY', 1)" class="p-2 bg-gray-200 rounded-r hover:bg-gray-300">+</button>
               </div>
               <p class="text-xs text-gray-500 mt-1">Positif (+) Turun Bawah, Negatif (-) Naik Atas</p>
             </div>

             <div>
               <label class="block text-sm font-bold text-gray-700">Jarak Antar Baris Header - mm</label>
               <div class="flex items-center mt-1">
                 <button type="button" onclick="adjustVal('set_headerGap', -0.5)" class="p-2 bg-gray-200 rounded-l hover:bg-gray-300">-</button>
                 <input type="number" id="set_headerGap" class="block w-full text-center border-gray-300 h-9 border-t border-b" value="0" step="0.5">
                 <button type="button" onclick="adjustVal('set_headerGap', 0.5)" class="p-2 bg-gray-200 rounded-r hover:bg-gray-300">+</button>
               </div>
             </div>

             <div>
                <label class="block text-sm font-bold text-gray-700">Ukuran Font (pt)</label>
                <input type="number" id="set_fontSize" class="input-field" value="10">
             </div>
          </div>
        </div>
        <div class="mt-5 sm:mt-6 flex flex-col gap-2">
          <button type="button" onclick="saveSettingsAndPreview()" class="inline-flex justify-center w-full px-4 py-2 text-base font-bold text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
            <i class="fa-solid fa-check-double mr-2 mt-0.5"></i> Simpan & Lihat Preview
          </button>
          
          <button type="button" onclick="saveSettings()" class="inline-flex justify-center w-full px-4 py-2 text-base font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none sm:text-sm">
            Simpan Saja
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PREVIEW PDF -->
  <div id="previewModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-90" onclick="closePreview()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
      
      <div class="inline-block bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:align-middle sm:max-w-5xl sm:w-full h-[90vh] flex flex-col">
        <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
          <h3 class="text-lg font-medium text-gray-900">Preview PDF</h3>
          <div class="flex gap-2">
             <button onclick="reopenSettings()" class="text-sm px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">
               <i class="fa-solid fa-gear"></i> Atur Lagi
             </button>
             <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700 ml-2">
               <i class="fa-solid fa-times text-xl"></i>
             </button>
          </div>
        </div>
        <div class="flex-grow bg-gray-500 p-4">
            <iframe id="pdfPreviewFrame" class="w-full h-full rounded shadow-lg border-0"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- KONFIGURASI PENTING ---
    const APP_CONFIG = {
        // !!! PENTING: Ganti URL di bawah dengan URL WEB APP Anda setelah deploy Code_Google_Sheet.gs !!!
        // Contoh: 'https://script.google.com/macros/s/AKfycbx.../exec'
        script_url: 'https://script.google.com/macros/s/AKfycbyXiHOSWUexe8PPHQWzsPm4IGAA7i22nnX28xcIyyWE-Nnypovr5vFrLHvlPRrc-lqBlQ/exec', 
        
        wa_token: 'T9SCfr4hZSmGEy8ngizJ',
        wa_target: '6282258110899-1604625450@g.us'
    };

    // --- DEFAULT CONFIG PDF ---
    let LAYOUT_CONFIG = {
      pageSize: { w: 229, h: 162 }, 
      fontSize: 10,
      fontName: 'courier', 
      globalOffset: { x: 5, y: 13 },
      headerGap: 0, 
      
      header: {
        no_sj: { x: 160, y: 22 }, 
        tanggal: { x: 160, y: 26 },
        no_so: { x: 160, y: 32.7 },
        transporter: { x: 160, y: 36.7 },
        tipe_truk: { x: 160, y: 44 },
        no_truk: { x: 160, y: 48 },
        driver: { x: 160, y: 52 }
      },
      tujuan: { x: 20, y: 32, maxWidth: 80, lineHeight: 5 },
      table: {
        startY: 68,     
        rowHeight: 6,    
        cols: {          
          kode: 12, nama: 42, uom: 95, qty_pesan: 110, qty_kirim: 130, berat: 150, total: 175
        }
      },
      footer: {
        pallet: { x: 90, y: 130 }
      }
    };

    // --- LOGIKA FORM ---
    window.onload = function() {
      addRow();
      document.querySelector('input[name="tanggal"]').valueAsDate = new Date();
      loadSettings(); 
    };

    function addRow() {
      const tbody = document.getElementById('tableBody');
      const tr = document.createElement('tr');
      // Perubahan: Menambahkan border pada td agar tabel terlihat ada garisnya
      tr.innerHTML = `
        <td class="px-2 py-1 border border-gray-300"><input type="text" name="item_kode[]" class="input-field text-xs h-8"></td>
        <td class="px-2 py-1 border border-gray-300"><input type="text" name="item_nama[]" class="input-field text-xs h-8"></td>
        <td class="px-2 py-1 border border-gray-300"><input type="text" name="item_uom[]" class="input-field text-xs h-8"></td>
        <td class="px-2 py-1 border border-gray-300"><input type="number" name="item_qty_pesan[]" class="input-field text-xs h-8"></td>
        <td class="px-2 py-1 border border-gray-300"><input type="number" name="item_qty_kirim[]" class="input-field text-xs h-8"></td>
        <td class="px-2 py-1 border border-gray-300"><input type="number" name="item_berat[]" class="input-field text-xs h-8" step="0.01"></td>
        <td class="px-2 py-1 border border-gray-300"><input type="number" name="item_total[]" class="input-field text-xs h-8" step="0.01"></td>
        <td class="px-2 py-1 border border-gray-300 text-center">
            <button type="button" onclick="this.closest('tr').remove()" class="text-red-600 hover:text-red-900 font-bold px-2 py-1 rounded hover:bg-red-50">X</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    function getFormDataFromDOM() {
      const form = document.getElementById('spjForm');
      const formData = new FormData(form);
      const data = {
        header: {
          tujuan: formData.get('tujuan'),
          no_sj: formData.get('no_sj'),
          tanggal: formData.get('tanggal'),
          no_so: formData.get('no_so'),
          transporter: formData.get('transporter'),
          tipe_truk: formData.get('tipe_truk'),
          no_truk: formData.get('no_truk'),
          driver: formData.get('driver'),
          pallet: formData.get('pallet')
        },
        items: []
      };

      const codes = formData.getAll('item_kode[]');
      const names = formData.getAll('item_nama[]');
      const uoms = formData.getAll('item_uom[]');
      const qtyPs = formData.getAll('item_qty_pesan[]');
      const qtyKs = formData.getAll('item_qty_kirim[]');
      const berats = formData.getAll('item_berat[]');
      const totals = formData.getAll('item_total[]');

      for (let i = 0; i < codes.length; i++) {
        if (names[i]) {
          data.items.push({
            kode: codes[i], nama: names[i], uom: uoms[i],
            qty_pesan: qtyPs[i], qty_kirim: qtyKs[i],
            berat: berats[i], total_berat: totals[i]
          });
        }
      }
      return data;
    }

    // --- PREVIEW PDF ---
    function handlePreview() {
      const data = getFormDataFromDOM();
      if(!data.header.no_sj) { alert('Mohon isi No. Surat Jalan (minimal dummy) untuk preview'); return; }

      const doc = createPDFObject(data);
      const pdfData = doc.output('datauristring');
      const iframe = document.getElementById('pdfPreviewFrame');
      iframe.src = pdfData;
      
      document.getElementById('previewModal').classList.remove('hidden');
      document.body.classList.add('modal-active');
    }

    function closePreview() {
      document.getElementById('previewModal').classList.add('hidden');
      document.body.classList.remove('modal-active');
    }

    function reopenSettings() {
      closePreview();
      toggleSettingsModal();
    }

    // --- LOGIKA SUBMIT (HYBRID: WA + PDF + GOOGLE SHEET VIA WEB APP) ---
    async function handleFormSubmit(e) {
      e.preventDefault();
      const btn = document.getElementById('btnSave');
      const status = document.getElementById('statusMessage');
      const data = getFormDataFromDOM();
      
      if(!data.header.no_sj) { alert("Isi No Surat Jalan!"); return; }

      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Memproses...';
      status.className = 'hidden';

      let logs = [];
      
      try {
        // 1. Generate PDF
        const doc = createPDFObject(data);
        const filename = `SJ_${data.header.no_sj.replace(/\//g, '-')}.pdf`;
        doc.save(filename);
        logs.push("‚úÖ PDF Berhasil Didownload");

        // 2. Kirim ke Google Sheet (jika URL Script diisi)
        if (APP_CONFIG.script_url && APP_CONFIG.script_url.includes('script.google.com')) {
           try {
              // Menggunakan mode no-cors karena Apps Script redirect
              await fetch(APP_CONFIG.script_url, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
              });
              logs.push("‚úÖ Data Terkirim ke Google Sheet");
           } catch (sheetErr) {
              console.error(sheetErr);
              logs.push("‚ö†Ô∏è Gagal simpan ke Sheet (Cek URL Script)");
           }
        } else {
           logs.push("‚ö†Ô∏è Data TIDAK disimpan ke Sheet (URL Script belum diisi di kode)");
        }

        // 3. Kirim WhatsApp
        try {
           await sendWhatsappMessage(data);
           logs.push("‚úÖ WhatsApp Terkirim");
        } catch (waErr) {
           console.error(waErr);
           logs.push("‚ö†Ô∏è Gagal kirim WA (Cek Koneksi/Token)");
        }

        // Tampilkan Status Akhir
        status.innerHTML = `<strong>Laporan Proses:</strong><br><ul>${logs.map(l => `<li>${l}</li>`).join('')}</ul>`;
        status.className = 'mt-4 p-4 bg-green-100 text-green-800 rounded-md border border-green-200 text-sm';

      } catch (err) {
        console.error(err);
        status.innerHTML = `<strong>Error Utama:</strong> ${err.message}`;
        status.className = 'mt-4 p-4 bg-red-100 text-red-700 rounded-md border border-red-200';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up mr-2 mt-0.5"></i> Simpan, Kirim WA & PDF';
      }
    }

    // --- FUNGSI KIRIM WA ---
    async function sendWhatsappMessage(data) {
        let pesan = `*LAPORAN TRANSAKSI TRADING*\n`;
        pesan += `--------------------------------\n`;
        pesan += `üìÖ Tanggal : ${data.header.tanggal}\n`;
        pesan += `üìÑ No. SJ   : ${data.header.no_sj}\n`;
        pesan += `üìÑ No. SO   : ${data.header.no_so}\n`;
        pesan += `üöõ Transporter: ${data.header.transporter} (${data.header.no_truk})\n`;
        pesan += `üë§ Driver   : ${data.header.driver}\n`;
        pesan += `üìç Tujuan   : ${data.header.tujuan.substring(0, 30)}...\n`;
        pesan += `üì¶ Pallet   : ${data.header.pallet}\n`;
        pesan += `--------------------------------\n`;
        pesan += `*DETAIL BARANG:*\n`;

        if (data.items && data.items.length > 0) {
            data.items.forEach((item, index) => {
            pesan += `${index + 1}. ${item.nama} (${item.kode})\n`;
            pesan += `   ‚û° Kirim: ${item.qty_kirim} ${item.uom}\n`;
            pesan += `   ‚û° Berat: ${item.total_berat} Ton\n`;
            });
        }
        pesan += `--------------------------------\n`;
        pesan += `_Dikirim dari Web GitHub_`;

        const formData = new FormData();
        formData.append('target', APP_CONFIG.wa_target);
        formData.append('message', pesan);

        const response = await fetch('https://api.fonnte.com/send', {
            method: 'POST',
            headers: { 'Authorization': APP_CONFIG.wa_token },
            body: formData
        });
        return await response.json();
    }

    // --- PDF GENERATOR CORE ---
    function createPDFObject(data) {
      const { jsPDF } = window.jspdf;
      const cfg = LAYOUT_CONFIG;
      
      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: [cfg.pageSize.w, cfg.pageSize.h]
      });

      doc.setFont(cfg.fontName, 'normal');
      doc.setFontSize(cfg.fontSize);

      const getX = (val) => val + cfg.globalOffset.x;
      const getY = (val) => val + cfg.globalOffset.y;
      
      const hGap = cfg.headerGap || 0;
      
      const txt = (str, x, y, lineIndex = 0) => { 
        if(str) {
           const finalY = getY(y) + (lineIndex * hGap);
           doc.text(String(str).toUpperCase(), getX(x), finalY); 
        }
      };

      const h = data.header;
      const hc = cfg.header;
      
      txt(h.no_sj, hc.no_sj.x, hc.no_sj.y, 0);
      
      let tgl = h.tanggal;
      if (tgl) {
        const d = new Date(tgl);
        tgl = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
      }
      txt(tgl, hc.tanggal.x, hc.tanggal.y, 1);
      
      txt(h.no_so, hc.no_so.x, hc.no_so.y, 2);
      txt(h.transporter, hc.transporter.x, hc.transporter.y, 3);
      txt(h.tipe_truk, hc.tipe_truk.x, hc.tipe_truk.y, 4);
      txt(h.no_truk, hc.no_truk.x, hc.no_truk.y, 5);
      txt(h.driver, hc.driver.x, hc.driver.y, 6);

      const tc = cfg.tujuan;
      if (h.tujuan) {
        const splitTujuan = doc.splitTextToSize(h.tujuan.toUpperCase(), tc.maxWidth);
        doc.text(splitTujuan, getX(tc.x), getY(tc.y));
      }

      let currentY = cfg.table.startY;
      const tableC = cfg.table;
      
      data.items.forEach(item => {
        const txtTable = (str, x, y) => { if(str) doc.text(String(str).toUpperCase(), getX(x), getY(y)); };
        
        txtTable(item.kode, tableC.cols.kode, currentY);
        txtTable(item.nama, tableC.cols.nama, currentY);
        txtTable(item.uom, tableC.cols.uom, currentY);
        txtTable(item.qty_pesan, tableC.cols.qty_pesan, currentY);
        txtTable(item.qty_kirim, tableC.cols.qty_kirim, currentY);
        txtTable(item.berat, tableC.cols.berat, currentY);
        txtTable(item.total_berat, tableC.cols.total, currentY);
        currentY += tableC.rowHeight;
      });

      if (h.pallet) {
        const txtFooter = (str, x, y) => { if(str) doc.text(String(str).toUpperCase(), getX(x), getY(y)); };
        txtFooter(h.pallet, cfg.footer.pallet.x, cfg.footer.pallet.y);
      }

      return doc;
    }

    // --- PENGATURAN KERTAS (LOGIC) ---
    function toggleSettingsModal() {
      const modal = document.getElementById('settingsModal');
      const isHidden = modal.classList.contains('hidden');
      
      if (isHidden) {
        modal.classList.remove('hidden');
        document.body.classList.add('modal-active');
        document.getElementById('set_offsetX').value = LAYOUT_CONFIG.globalOffset.x;
        document.getElementById('set_offsetY').value = LAYOUT_CONFIG.globalOffset.y;
        document.getElementById('set_headerGap').value = LAYOUT_CONFIG.headerGap;
        document.getElementById('set_fontSize').value = LAYOUT_CONFIG.fontSize;
      } else {
        modal.classList.add('hidden');
        document.body.classList.remove('modal-active');
      }
    }

    function adjustVal(id, delta) {
       const el = document.getElementById(id);
       let val = parseFloat(el.value) || 0;
       el.value = (val + delta).toFixed(1).replace(/\.0$/, ''); 
    }

    function saveToMemory() {
      const x = parseFloat(document.getElementById('set_offsetX').value) || 0;
      const y = parseFloat(document.getElementById('set_offsetY').value) || 0;
      const hGap = parseFloat(document.getElementById('set_headerGap').value) || 0;
      const fSize = parseFloat(document.getElementById('set_fontSize').value) || 10;

      LAYOUT_CONFIG.globalOffset.x = x;
      LAYOUT_CONFIG.globalOffset.y = y;
      LAYOUT_CONFIG.headerGap = hGap;
      LAYOUT_CONFIG.fontSize = fSize;

      localStorage.setItem('sj_config_offset_x', x);
      localStorage.setItem('sj_config_offset_y', y);
      localStorage.setItem('sj_config_header_gap', hGap);
      localStorage.setItem('sj_config_font_size', fSize);
    }

    function saveSettings() {
      saveToMemory();
      toggleSettingsModal();
    }

    function saveSettingsAndPreview() {
      saveToMemory();
      toggleSettingsModal(); 
      setTimeout(() => {
         handlePreview();
      }, 300);
    }

    function loadSettings() {
      const x = localStorage.getItem('sj_config_offset_x');
      const y = localStorage.getItem('sj_config_offset_y');
      const hGap = localStorage.getItem('sj_config_header_gap');
      const fSize = localStorage.getItem('sj_config_font_size');

      if (x !== null) LAYOUT_CONFIG.globalOffset.x = parseFloat(x);
      if (y !== null) LAYOUT_CONFIG.globalOffset.y = parseFloat(y);
      if (hGap !== null) LAYOUT_CONFIG.headerGap = parseFloat(hGap);
      if (fSize !== null) LAYOUT_CONFIG.fontSize = parseFloat(fSize);
    }
  </script>
</body>
</html>
